//Get file from GitHub
wget https://github.com/ywchiu/micronbigdata/raw/master/Hive/purchase_view.tab
wget https://github.com/ywchiu/micronbigdata/raw/master/Hive/purchase_order.tab

//Create finance database
mysql -e 'create database costumer' 

//Create table MajorTrade
mysql -uroot costumer< create-tb.sql

//Import finance.csv into MajorTrade
mysql costumer -e "LOAD DATA LOCAL INFILE 'purchase_order.tab' INTO TABLE costumer_order FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' (Time,Action,User,Product, Quantity,Price)"
mysql costumer -e "LOAD DATA LOCAL INFILE 'purchase_view.tab' INTO TABLE costumer_view FIELDS TERMINATED BY '\t' LINES TERMINATED BY '\n' (Time,Action,User,Product)"

//Using sqoop to import data
sqoop import --connect jdbc:mysql://localhost:3306/costumer -username root --query "select * from costumer_order where 1=1 and \$CONDITIONS" --hive-table costumer_order --create-hive-table --hive-import --hive-home /apps/hive/warehouse -m1 --target-dir costumer_order  --driver com.mysql.jdbc.Driver
sqoop import --connect jdbc:mysql://localhost:3306/costumer -username root --query "select * from costumer_view where 1=1 and \$CONDITIONS" --hive-table costumer_view --create-hive-table --hive-import --hive-home /apps/hive/warehouse -m1 --target-dir costumer_view  --driver com.mysql.jdbc.Driver

//Entering hive
hive

//Making queries
SELECT date, sum(value) as sum_val FROM MajorTrade group by date order by sum_val desc limit 1;

//Making subqueries
SELECT item, (sum(value) * 100 / t.total)  as percent 
FROM MajorTrade 
  CROSS  JOIN (
      SELECT sum(value) AS total FROM MajorTrade
  ) t 
GROUP BY item, t.total;

//Create table in hive
create table item_portion (item String, portion float);

//Insert data into item_portion
INSERT INTO TABLE item_portion
SELECT item, (sum(value) * 100 / t.total)  as percent 
FROM MajorTrade 
  CROSS  JOIN (
      SELECT sum(value) AS total FROM MajorTrade
  ) t 
GROUP BY item, t.total;

//Create table item_portion in finance
mysql -uroot -p finance -e 'create table item_portion (item varchar(100), portion float)'

//Using sqoop to export data back to mysql
sqoop export --connect jdbc:mysql://localhost:3306/finance --table item_portion --export-dir /user/hive/warehouse/item_portion --username root -password cloudera -m1 --input-fields-terminated-by '\001'
